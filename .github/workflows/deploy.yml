name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --production

      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USERNAME: ${{ secrets.EC2_USERNAME }}
          KEY: ${{ secrets.EC2_SSH_KEY }}
          PORT: ${{ secrets.EC2_SSH_PORT }}
        run: |
          echo "$KEY" > private_key
          chmod 600 private_key

          ssh -o StrictHostKeyChecking=no -i private_key -p ${PORT:-22} ${USERNAME}@${HOST} "mkdir -p ~/pjn-api"

          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '.env' \
            --exclude 'private_key' \
            --exclude '.github' \
            --exclude 'logs' \
            --exclude '*.log' \
            -e "ssh -o StrictHostKeyChecking=no -i private_key -p ${PORT:-22}" \
            ./ ${USERNAME}@${HOST}:~/pjn-api/

          ssh -o StrictHostKeyChecking=no -i private_key -p ${PORT:-22} ${USERNAME}@${HOST} << 'ENDSSH'
            sudo -s <<'ENDROOT'
              cd ~/pjn-api

              echo "ðŸ“¦ Installing dependencies..."
              npm ci --production

              echo "ðŸ“¦ Installing PM2 globally..."
              npm i -g pm2

              echo "ðŸ”„ Reloading PM2 application..."
              pm2 reload ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
              pm2 save

              echo "ðŸ“Š PM2 Status:"
              pm2 status

              echo "ðŸ“‹ Application logs (last 20 lines):"
              pm2 logs "pjn/api" --lines 20 --nostream || true

              echo "âœ… Deployment completed!"
            ENDROOT
          ENDSSH

          rm -f private_key

      - name: Health Check via SSH
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USERNAME: ${{ secrets.EC2_USERNAME }}
          KEY: ${{ secrets.EC2_SSH_KEY }}
          SSH_PORT: ${{ secrets.EC2_SSH_PORT }}
        run: |
          echo "$KEY" > private_key_health
          chmod 600 private_key_health

          ssh -o StrictHostKeyChecking=no -i private_key_health -p ${SSH_PORT:-22} ${USERNAME}@${HOST} <<'ENDSSH'
            sudo -s <<'ENDROOT'
              echo "ðŸ“Š PM2 Status:"
              pm2 status

              echo ""
              echo "ðŸ” Checking pjn/api process:"
              if pm2 status | grep -q 'pjn/api.*online'; then
                echo "âœ… Application is running!"

                echo ""
                echo "ðŸ“‹ Recent logs:"
                pm2 logs "pjn/api" --lines 10 --nostream || true

                exit 0
              else
                echo "âŒ Application is not running or not in 'online' status"

                echo ""
                echo "ðŸ“‹ Error logs:"
                pm2 logs "pjn/api" --lines 20 --nostream || true

                exit 1
              fi
            ENDROOT
          ENDSSH

          rm -f private_key_health
